<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- FontAwesome Icons Import -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
    <!-- Material Icons Import -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
    <!-- Material Design Icons Import -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css">
    <!-- Line Awesome Icons Import -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/line-awesome/dist/line-awesome/css/line-awesome.min.css">
    <!-- Boostrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.min.css">
    
    <title>OK1ez</title>
    <script type="module" crossorigin src="./index.js"></script>
    <link rel="stylesheet" href="./index.css">
  </head>
  <body>
    <div id="app"></div>
    
    <!-- Mock de eventos do FiveM -->
    <script>
        // Simula o GetParentResourceName
        window.GetParentResourceName = () => 'ps-dispatch';

        // Função helper para disparar eventos
        function dispatchNUIMessage(action, data) {
            window.dispatchEvent(
                new MessageEvent('message', {
                    data: { action, data }
                })
            );
        }

        // Aguarda carregar completamente
        window.addEventListener('load', () => {
            // Pequeno delay para garantir que o Svelte inicializou
            setTimeout(() => {
                // 1. Configuração inicial da UI
                dispatchNUIMessage('setupUI', {
                    player: {
                        citizenid: 'TEST123',
                        job: {
                            name: 'LSPD',
                            type: 'leo'
                        },
                        charinfo: {
                            firstname: 'John',
                            lastname: 'Doe'
                        },
                        metadata: {
                            callsign: '1-A-12'
                        }
                    },
                    locales: {
                        units: 'Units',
                        additionals: 'Additional',
                        dispatch_attach: 'Attach',
                        dispatch_detach: 'Detach'
                    },
                    keybind: 'F10',
                    maxCallList: 10,
                    shortCalls: false
                });

                // 2. Lista de dispatches
                dispatchNUIMessage('setDispatchs', [
                    {
                        id: 1,
                        code: '10-31',
                        message: 'Robbery in Progress',
                        priority: 1,
                        icon: 'fas fa-gun',
                        time: new Date().toISOString(),
                        name: 'Jane Smith',
                        number: '555-0123',
                        information: 'Armed suspect, multiple hostages',
                        street: 'Legion Square',
                        gender: 'Male',
                        weapon: 'Pistol',
                        vehicle: 'Sultan',
                        plate: 'ABC123',
                        color: 'Black',
                        class: 'Sports',
                        doors: '4',
                        heading: 'North',
                        units: [],
                        jobs: ['leo']
                    },
                    {
                        id: 2,
                        code: '10-50',
                        message: 'Traffic Accident',
                        priority: 0,
                        icon: 'fas fa-car-crash',
                        time: new Date(Date.now() - 300000).toISOString(),
                        name: 'Bob Johnson',
                        number: '555-0456',
                        information: 'Minor injuries reported',
                        street: 'Great Ocean Highway',
                        units: [
                            {
                                citizenid: 'TEST123',
                                job: {
                                    name: 'LSPD',
                                    type: 'leo'
                                },
                                charinfo: {
                                    firstname: 'John',
                                    lastname: 'Doe'
                                },
                                metadata: {
                                    callsign: '1-A-12'
                                }
                            }
                        ],
                        jobs: ['leo', 'ems']
                    }
                ]);

                // 3. Tornar visível
                dispatchNUIMessage('setVisible', true);

                // 4. Simular nova chamada após 3 segundos
                setTimeout(() => {
                    dispatchNUIMessage('newCall', {
                        data: {
                            id: 3,
                            code: '10-90',
                            message: 'Alarm Activated',
                            priority: 1,
                            icon: 'fas fa-bell',
                            time: new Date().toISOString(),
                            name: 'Security System',
                            information: 'Silent alarm at Fleeca Bank',
                            street: 'Route 68',
                            units: [],
                            jobs: ['leo']
                        },
                        timer: 15000
                    });
                }, 3000);

            }, 300);
        });

        // Função global para testar no console
        window.testCall = function() {
            dispatchNUIMessage('newCall', {
                data: {
                    id: Math.floor(Math.random() * 1000),
                    code: '10-99',
                    message: 'Test Call',
                    priority: Math.random() > 0.5 ? 1 : 0,
                    icon: 'fas fa-question',
                    time: new Date().toISOString(),
                    information: 'This is a test call',
                    street: 'Test Street',
                    units: [],
                    jobs: ['leo']
                },
                timer: 10000
            });
            console.log('Test call dispatched!');
        };

        // Atalho para mostrar/esconder
        document.addEventListener('keydown', (e) => {
            if (e.key === '=') {
                dispatchNUIMessage('setVisible', true);
            }
        });

        console.log('Mock loaded! Use testCall() to create a new dispatch');

        // Script para adicionar o tempo no canto inferior direito
        function addTimeElements() {
            // Para os cards do Menu (dispatch list)
            const menuCards = document.querySelectorAll('.flex.flex-col.p-\\[1vh\\].gap-y-\\[0\\.4vh\\].text-\\[1\\.4vh\\].w-full.text-start');
            menuCards.forEach(card => {
                const parent = card.parentElement;
                if (parent && parent.style.position !== 'relative') {
                    parent.style.position = 'relative';

                    // Encontrar o tempo no texto (campo escondido)
                    const timeText = Array.from(card.querySelectorAll('p')).find(p => {
                        const icon = p.querySelector('i.fa-clock');
                        return icon !== null;
                    });

                    if (timeText && !parent.querySelector('.time-badge-menu')) {
                        const timeValue = timeText.textContent.replace(/Horário:\s*/i, '').trim();

                        // Encontrar o último elemento visível para alinhar
                        const lastVisibleP = Array.from(card.querySelectorAll('p')).filter(p => {
                            return !p.querySelector('i.fa-clock') && p.textContent.trim();
                        }).pop();

                        const timeBadge = document.createElement('div');
                        timeBadge.className = 'time-badge-menu';

                        // Adicionar diretamente no card, não no parent
                        card.appendChild(timeBadge);

                        // Ajustar o estilo para ficar inline com os textos
                        timeBadge.style.cssText = 'position: absolute; right: 1vh; display: flex; align-items: center; gap: 0.5vh; font-size: 1.3vh; pointer-events: none; color: #4e4e50; top: auto; bottom: 1vh;';
                        timeBadge.innerHTML = `<i class="fa-regular fa-clock" style="color: #4e4e50;"></i><span>${timeValue}</span>`;
                    }
                }
            });

            // Para as notificações (Main)
            const notificationWrappers = document.querySelectorAll('.flex[style*="position: relative"]');
            notificationWrappers.forEach(wrapper => {
                const card = wrapper.querySelector('.flex.flex-col.p-\\[1vh\\].gap-y-\\[0\\.4vh\\].text-\\[1\\.4vh\\].w-\\[70\\%\\]');
                if (card && !card.querySelector('.time-badge-notification')) {
                    // Encontrar o tempo no texto (campo escondido)
                    const timeText = Array.from(card.querySelectorAll('p')).find(p => {
                        const icon = p.querySelector('i.fa-clock');
                        return icon !== null;
                    });

                    if (timeText) {
                        const timeValue = timeText.textContent.replace(/Horário:\s*/i, '').trim();

                        const timeBadge = document.createElement('div');
                        timeBadge.className = 'time-badge-notification';
                        timeBadge.style.cssText = 'position: absolute; bottom: 1vh; right: 1vh; display: flex; align-items: center; gap: 0.5vh; font-size: 1.3vh; color: #4e4e50;';
                        timeBadge.innerHTML = `<i class="fa-regular fa-clock" style="color: #4e4e50;"></i><span>${timeValue}</span>`;

                        card.appendChild(timeBadge);
                    }
                }
            });
        }

        // Observer para detectar mudanças no DOM
        const observer = new MutationObserver(() => {
            addTimeElements();
        });

        // Iniciar observação
        setTimeout(() => {
            const app = document.getElementById('app');
            if (app) {
                observer.observe(app, { childList: true, subtree: true });
                addTimeElements(); // Executar imediatamente também
            }
        }, 500);

        // Executar periodicamente para garantir
        setInterval(addTimeElements, 1000);
    </script>
  </body>
</html>